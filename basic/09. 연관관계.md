# 연관관계

객체 관계 매핑(ORM)에서 가장 어려운 부분이 바로 객체 연관관계와 테이블 연관관계를 매핑하는 일이다. 즉, __객체의 참조와 테이블의 외래 키를 매핑하는 것__ 이 중요하다.

- 방향(Direction)
  - 단방향
    - 회원 -> 회사 or 회사 -> 회원 둘 중 한쪽만 참조하는 것
  - 양방향
    - 테이블은 항상 양방향이다.

- 다중성(Multiplicity)
  - 다대일(N:1) : 회원(N)이 속한 회사(1)를 조회
  - 일대다(1:N) : 회사(1)가 자기 회원(N)을 조회
  - 일대일(1:1) 
  - 다대다(N:M)

- 연관관계의 주인(owner)
  - 객체를 양방향 연관관계로 만들면 연관관계의 주인을 정해야 한다.

## 다대일 연관관계

- 객체 연관관계
  - 회원이 회사를 조회하는 다대일 연관관계의 경우 회원 필드에는 회사를 참조하고 있는 필드가 존재한다. 반면 회사 엔티티에는 회원을 참조하는 필드가 존재하지 않는다.
- 테이블 연과관계
  - 회원 테이블은 회사의 외래키를 가지고 있어서 서로 조인하여 조회할 수 있다. 따라서 양방향 연관관계이다.

> 객체 연관관계와 테이블 연관관계의 가장 큰 차이
>
> 객체간에 연관관계를 양방향으로 만들고 싶으면 반대쪽에도 참조하는 필드를 추가해야 한다. 결국 연관관계를 하나 더 만들어야 하는데 정확히는 `양방향이 아니라 서로 다른 단방향 관계가 2개`인 것이다.
> 반면, 테이블은 외래 키 하나로 양방향으로 조인할 수 있다.

## @ManyToOne

테이블은 항상 양방향 연관관계를 가진다. 하지만 객체는 사실상 양방향 연관관계를 가지지 못하고, 비지니스 규칙으로 잘 묶어서 서로 다른 단방향 연관관계를 양방향 처럼 보이게 하는 것이다.

서로 다른 엔티티에서 양방향 연관관계처럼 보이게 하기 위해서는 @ManyToOne or @OneToMany 를 설정해야 한다. (혹은 @OneToOne) 여기서 `연관관계의 주인`을 설정해야하는데, 연관관계의 주인이란
테이블의 외래키를 수정하고 다룰 수 있는 엔티티를 의미한다. 연관관계의 주인은 항상 `@ManyToOne`쪽이 된다. 즉, 테이블에서 실제로 FK 를 가지고 있는 테이블이 연관관계의 주인이 된다.

## 식별관계와 비식별관계

식별관계는 한 테이블의 기본키가 다른 테이블에서 기본키 + 외래키로 사용되는 경우인데, 식별관계를 사용하는 경우 `@IdClass` 난 `@EmbeddedId` 를 사용해야 한다. 식별관계의 복합키를 사용하는 경우보다 비식별관계처럼 인조키를 만들어 사용하는 편이 더 편하다. 

식별관계는 테이블의 기본키를 자식 테이블로 전파하면서 자식 테이블의 기본키 컬럼이 점점 늘어난다. 그리고 식별관계는 2개 이상의 컬럼을 합해서 복합키로 사용하는 경우가 많다.
__식별 관계를 사용할 때 기본 키로 비지니스 의미가 있는 자연 키 컬럼을 조합하는 경우가 많은데, 비지니스는 언제든 변경될 가능성이 있다.__ 따라서, 비식별 관계 처럼 인조키를 만들어 주로 사용한다.

__가급적, 비식별 관계를 사용하고 기본 키는 Long 타입의 대리키를 사용하는 것이다.__ 그리고 선택적 비식별 관계보다는 필수적 비식별 관계를 사용하는 것이 좋다.
선택적 비식별관계는 NULL 을 허용하므로 조인할 때 외부조인을 사용해야 한다. 반면 필수적 비식별 관계는 NOT NULL 이기 때문에 항상 관계가 있다는 것을 보장하므로 내부 조인만 사용해도 된다.
