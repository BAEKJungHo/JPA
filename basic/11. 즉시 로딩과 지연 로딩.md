# 즉시 로딩과 지연 로딩

- 즉시 로딩(EAGER LOADING)
  - 엔티티를 조회할 때 연관된 엔티티도 함께 조회한다.
  - 설정방법 : `@ManyToOne(fetch = FetchType.EAGER)`

- 지연 로딩(LAZY LOADING)
  - 연관된 엔티티를 실제 사용할 때 조회한다.
  - 설정방법 : `@ManyToOne(fetch = FetchType.LAZY)`

## 즉시 로딩

```java
@Entity
public class User {

  @ManyToOne(fetch = FetchType.EAGER)
  @JoinColumn(name = "TEAM_ID")
  private Team team;

}
```

대부분의 JPA 구현체는 __즉시 로딩을 최적화화기 위해 가능하면 조인 쿼리를 사용한다.__

위 경우에는 외부 조인 LEFT OUTER JOIN 을 사용한다. 왜냐하면 회원이 Team 에 소속되어있지 않을 수도 있기 때문이다.

## 외부조인과 내부조인 사용

- nullable 설정에 따른 조인 전략
  - @JoinColumn(nullable = true) : 기본값, 외부 조인 사용
  - @JoinColumn(nullable = false) : 내부 조인 사용

`@ManyToOne(optional = false)` : 내부 조인 사용

JPA 는 선택적 관계면 외부 조인을 사용하고 필수 관계면 내부 조인을 사용한다.

> A와 B를 Innter-Join 하면 A와 B의 `교집합`을 얻을 수 있습니다.
> 
> A와 B를 Outer-Join 하면 A와 B의 `합집합`을 얻을 수 있습니다.
> 
> https://jetalog.net/28

## 지연 로딩

```java
@Entity
public class User {

  @ManyToOne(fetch = FetchType.LAZY)
  @JoinColumn(name = "TEAM_ID")
  private Team team;

}
```

```java
User user = em.find(User.class, "user1");
Team team = user.getTeam(); // 객체 그래프 탐색, 프록시 객체
user.getName(); // 팀 객체 실제 사용
```

## 프록시와 컬렉션 래퍼

```java
User user = em.find(User.class, "user1");
List<Order> orders = user.getOrders();
orders.getClass().getName(); // org.hibernate.collection.internal.PersistenctBag
```

하이버네이트는 엔티티를 영속 상태로 만들 대 엔티티에 컬렉션이 있으면 컬렉션을 추적하고 관리할 목적으로 원본 컬렉션을 하이버네이트가 제공하는 내장 컬렉션으로 변경하는데 이것을 컬렉션 래퍼라고 한다.

즉, user.getOrders() 를 호출해도 컬렉션은 초기화 되지 않고, user.getOrders().get(0) 처럼 실제로 사용해야 초기화가 된다.

## JPA 기본 Fetch 전략

- @ManyToOne, @OneToOne : 즉시 로딩(FetchType.EAGER)
- @OneToMany, @ManyToMany : 지연 로딩(FetchType.LAZY)

JPA 의 기본 패치 전략은 연관된 엔티티가 하나면 즉시 로딩을, 컬렉션이면 지연 로딩을 사용한다. __추천하는 방법은 모든 연관관계에 지연 로딩(Lazy loading)을 사용하는 것이다.__ 그리고 애플리케이션 개발이 어느 정도 완료돤계에
왔을 때 실제 사용하는 상황을 보고 꼭 필요한 곳에만 즉시 로딩을 사용하도록 최적화화면 된다.

### 즉시 로딩(FetchType.EAGER)시 주의 점

- 컬렉션을 하나 이상 즉시 로딩하는 것은 권장하지 않는다.
- 컬렉션 즉시 로딩은 항상 외부 조인을 사용한다.

- @ManyToOne, @OneToOne
  - optional = false : 내부 조인
  - optional = true : 외부 조인
- @OneToMany, @ManyToMany
  - optional = false : 외부 조인
  - optional = true : 외부 조인
